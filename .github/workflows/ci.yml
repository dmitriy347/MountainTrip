name: CI

# ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Ð—Ð°Ð´Ð°Ñ‡Ð¸
jobs:
  # Ð—Ð°Ð´Ð°Ñ‡Ð° 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
  lint:
    name: ðŸ” Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout code
        uses: actions/checkout@v4

      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
      - name: Install linting tools
        run: |
          pip install -r requirements-dev.txt

      # Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (Black)
      - name: Check formatting with Black
        run: |
          black --check config/

      # Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð´Ð° (Flake8)
      - name: Lint with Flake8
        run: |
          flake8 config/

  # Ð—Ð°Ð´Ð°Ñ‡Ð° 2: Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest

    # Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹ (PostgreSQL Ð¸ Redis)
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´
      - name: Checkout code
        uses: actions/checkout@v4

      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      # Ð¨Ð°Ð³ 4: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
      - name: Set up environment variables
        run: |
          cat > .env << 'EOF'
          DEBUG=True
          SECRET_KEY=${{ secrets.CI_SECRET_KEY || 'test-secret-key-for-ci-fallback' }}
          
          DB_NAME=test_db
          DB_USER=postgres
          DB_PASSWORD=postgres
          DB_HOST=localhost
          DB_PORT=5432
          
          REDIS_URL=redis://localhost:6379/1
          ALLOWED_HOSTS=localhost,127.0.0.1
          EOF

      # Ð¨Ð°Ð³ 5: Ð”Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ PostgreSQL
      - name: Wait for PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          until pg_isready -h localhost -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      # Ð¨Ð°Ð³ 6: ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
      - name: Run migrations
        run: |
          cd config
          python manage.py migrate --noinput

      # Ð¨Ð°Ð³ 7: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹
      - name: Run tests
        run: |
          cd config
          pytest -v --reuse-db