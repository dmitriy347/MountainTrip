name: Database Backup to S3

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC (6:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É)
    - cron: '0 3 * * *'
  workflow_dispatch:  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  backup:
    name: üóÑÔ∏è Backup PostgreSQL to S3
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github_actions
          chmod 600 ~/.ssh/github_actions
          # –î–æ–±–∞–≤–ª—è–µ–º -t rsa –¥–ª—è IP-–∞–¥—Ä–µ—Å–æ–≤
          ssh-keyscan -t rsa -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: üóÑÔ∏è Create database backup
        run: |
          BACKUP_FILE="db_backup_$(date +%Y-%m-%d_%H-%M-%S).sql.gz"
          
          ssh -i ~/.ssh/github_actions ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd /opt/skitrip && docker exec skitrip_db pg_dump -U postgres skitrip_db | gzip" > $BACKUP_FILE
          
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV
          ls -lh $BACKUP_FILE

      - name: ‚òÅÔ∏è Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-central-1
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AWS CLI
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –±—ç–∫–∞–ø –≤ S3
          aws s3 cp $BACKUP_FILE s3://skitrip-backups-2025/database/
          
          echo "‚úÖ Backup uploaded to S3!"

      - name: üßπ Cleanup old backups (keep last 7 days)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-central-1
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
          CUTOFF_DATE=$(date -d '7 days ago' +%Y-%m-%d)
          
          aws s3 ls s3://skitrip-backups-2025/database/ | while read -r line; do
            FILE_DATE=$(echo $line | awk '{print $1}')
            FILE_NAME=$(echo $line | awk '{print $4}')
            
            if [[ "$FILE_DATE" < "$CUTOFF_DATE" ]]; then
              echo "Deleting old backup: $FILE_NAME"
              aws s3 rm s3://skitrip-backups-2025/database/$FILE_NAME
            fi
          done
          
          echo "‚úÖ Old backups cleaned up!"

      - name: üìä Backup summary
        run: |
          echo "### üéâ Backup completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`$BACKUP_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** $(ls -lh $BACKUP_FILE | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "**Location:** \`s3://skitrip-backups-2025/database/\`" >> $GITHUB_STEP_SUMMARY